<!-- public/index.html -->
<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Dashboard Bascula</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.socket.io/4.6.1/socket.io.min.js"></script>
  <style>
    body{font-family:Inter,Arial;padding:18px;}
    .row{display:flex;gap:18px;}
    #left{flex:1} #right{width:380px}
    .card{background:#fafafa;padding:12px;border-radius:8px;box-shadow:0 1px 4px rgba(0,0,0,0.06)}
    #chat{height:300px;overflow:auto;border:1px solid #eee;padding:8px;border-radius:6px;background:#fff}
  </style>
</head>
<body>
  <h2>Dashboard Báscula — Tiempo real</h2>
  <div class="row">
    <div id="left">
      <div class="card">
        <h3>Última lectura</h3>
        <div id="last" style="font-size:28px">—</div>
        <div id="userinfo" style="color:#666">Usuario: <span id="username">Sin seleccionar</span></div>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>Gráfica (últimas 50)</h3>
        <canvas id="chart" height="120"></canvas>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>Registrar usuario</h3>
        <input id="newname" placeholder="Nombre..." />
        <button onclick="createUser()">Crear</button>
        <select id="userselect" onchange="selectUser()">
          <option value="">(Sin usuario)</option>
        </select>
      </div>
    </div>

    <div id="right">
      <div class="card">
        <h3>Chatbot</h3>
        <div id="chat"></div>
        <input id="msg" placeholder="Pregunta (ej. dame un plan)" style="width:100%"/>
        <button onclick="sendMsg()" style="margin-top:8px;width:100%">Enviar</button>
      </div>

      <div class="card" style="margin-top:12px">
        <h3>Historial reciente</h3>
        <ul id="history"></ul>
      </div>
    </div>
  </div>

<script>
  const socket = io();
  let chart, chartData = { labels: [], datasets: [{ label:'Peso (kg)', data: [] }] };
  let selectedUserId = null, selectedUserName = '';

  function initChart(){
    const ctx = document.getElementById('chart').getContext('2d');
    chart = new Chart(ctx, {
      type:'line',
      data: chartData,
      options:{plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}}}
    });
  }

  async function loadUsers(){
    const r = await fetch('/api/users');
    const users = await r.json();
    const sel = document.getElementById('userselect');
    sel.innerHTML = '<option value="">(Sin usuario)</option>';
    users.forEach(u=>{
      const o = document.createElement('option'); o.value = u.id; o.textContent=u.nombre;
      sel.appendChild(o);
    });
  }

  async function createUser(){
    const name = document.getElementById('newname').value.trim();
    if(!name) return alert('Escribe un nombre');
    const r = await fetch('/api/users',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({nombre:name})});
    document.getElementById('newname').value='';
    await loadUsers();
  }

  function selectUser(){
    const sel = document.getElementById('userselect');
    selectedUserId = sel.value || null;
    selectedUserName = sel.options[sel.selectedIndex]?.text || 'Sin seleccionar';
    document.getElementById('username').textContent = selectedUserName;
  }

  function pushReading(row){
    // mostrar última lectura
    document.getElementById('last').textContent = `${row.peso.toFixed(2)} kg`;
    document.getElementById('username').textContent = row.usuario || 'Sin usuario';

    // agregar al historial visual
    const li = document.createElement('li');
    li.textContent = `${row.fecha} — ${row.usuario||'Anon'} — ${row.peso} kg`;
    const hist = document.getElementById('history');
    hist.prepend(li);
    while(hist.children.length>20) hist.removeChild(hist.lastChild);

    // actualizar chart
    chartData.labels.push(row.fecha);
    chartData.datasets[0].data.push(row.peso);
    if(chartData.labels.length>50){ chartData.labels.shift(); chartData.datasets[0].data.shift(); }
    chart.update();
  }

  socket.on('connect', ()=>{ console.log('Socket conectado'); });
  socket.on('nueva_lectura', (row)=>{
    pushReading(row);
  });

  // cargar lecturas iniciales
  async function loadInitial(){
    initChart();
    await loadUsers();
    const r = await fetch('/api/lecturas');
    const rows = await r.json();
    rows.reverse().forEach(pushReading);
  }

  // Chatbot UI
  async function sendMsg(){
    const text = document.getElementById('msg').value.trim();
    if(!text) return;
    // mostrar en chat
    const chat = document.getElementById('chat');
    const userLine = document.createElement('div'); userLine.innerHTML = `<b>Tú:</b> ${text}`; chat.appendChild(userLine);
    document.getElementById('msg').value='';

    const body = { user_id: selectedUserId, peso: (chartData.datasets[0].data.length?chartData.datasets[0].data.at(-1):0), text };
    const r = await fetch('/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    const j = await r.json();
    const botLine = document.createElement('div'); botLine.innerHTML = `<b>Bot:</b> ${j.reply}`; chat.appendChild(botLine);
    chat.scrollTop = chat.scrollHeight;
  }

  loadInitial();
</script>
</body>
</html>
